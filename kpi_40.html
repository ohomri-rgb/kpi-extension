<!DOCTYPE html>
<html><head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>KPI</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;600;800&display=swap" rel="stylesheet">
<script src="tableau.extensions.js"></script>
<script src="chart.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;font-family:'Noto Sans Hebrew',sans-serif;background:#fff;overflow:hidden}
/* BUG 1+2 FIX: start invisible, fade in after load — hides blank "—" flash and softens stagger between cards */
#app{padding:3%;height:100%;display:flex;flex-direction:column;opacity:0}
.lbl{font-weight:600;color:#374151}
.val-row{display:flex;align-items:baseline;gap:0.3em;margin:0.2em 0 0.2em;flex-wrap:nowrap}
.val{font-weight:800;color:#111;letter-spacing:-1.5px;line-height:1}
.chg{font-weight:600}
.up{color:#16a34a}.down{color:#dc2626}
.period-cur{color:#6b7280;font-weight:500;margin-bottom:0.1em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.period-cur span.date-val{color:#374151;font-weight:500}
.wrap{flex:1;min-height:0;position:relative}
</style></head><body>
<!-- BUG 2 FIX: empty initial content instead of "—" so nothing ugly shows before fade-in -->
<div id="app">
  <div class="lbl" id="lbl"></div>
  <div class="val-row">
    <div class="val" id="val"></div>
    <div class="chg" id="chg"></div>
  </div>
  <div class="period-cur"><span id="cur-label"></span> <span id="cur"></span></div>
  <div class="period-cur" id="period-cmp-row" style="display:none"><span id="vs-label"></span> <span id="prev"></span></div>
  <div class="wrap" id="wrap"><canvas id="ch"></canvas></div>
  <div style="font-size:10px;color:#d1d5db;text-align:left;direction:ltr;margin-top:2px">v47</div>
<script>
var G=function(id){return document.getElementById(id);};
var fmt=function(n){return n!=null?n.toLocaleString('en-US',{notation:'compact',maximumFractionDigits:1}):'—';};
var ch=null,ws=null,timer=null,firstLoad=true;

var LANG={
  he:{current:'תקופה נוכחית:',vs:'השוואה:',dir:'rtl',lineCur:'נוכחי',linePrv:'שנה קודמת'},
  en:{current:'Current:',vs:'vs:',dir:'ltr',lineCur:'Current',linePrv:'Prior Year'}
};
var MONTHS={january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11,jan:0,feb:1,mar:2,apr:3,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};

function isHebrew(s){return /[\u0590-\u05FF]/.test(s);}
function applyLang(name){
  var L=isHebrew(name)?LANG.he:LANG.en,app=G('app');
  app.style.direction=L.dir;app.style.textAlign=L.dir==='rtl'?'right':'left';
  G('cur-label').textContent=L.current;G('vs-label').textContent=L.vs;
  return L;
}
function setFonts(){
  var b=Math.min(window.innerWidth,window.innerHeight);
  G('lbl').style.fontSize=Math.round(b*0.07)+'px';
  G('val').style.fontSize=Math.round(b*0.14)+'px';
  G('chg').style.fontSize=Math.round(b*0.06)+'px';
  var p=Math.round(b*0.05)+'px';
  document.querySelectorAll('.period-cur').forEach(function(el){el.style.fontSize=p;});
}
window.addEventListener('resize',setFonts);

function hexToRgba(hex,a){
  var c=(hex||'').replace('#','');
  if(c.length===3)c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];
  var r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);
  return isNaN(r)?'rgba(99,102,241,'+a+')':'rgba('+r+','+g+','+b+','+a+')';
}
function parseDate(raw,fv){
  var d=new Date(raw),s,m;
  if(!isNaN(d)&&d.getFullYear()>1990)return d;
  d=new Date(fv);
  if(!isNaN(d)&&d.getFullYear()>1990)return d;
  s=String(fv||raw||'');
  if((m=s.match(/([A-Za-z]+)\s+(\d{4})/))&&MONTHS[m[1].toLowerCase()]!==undefined)return new Date(+m[2],MONTHS[m[1].toLowerCase()],1);
  if(m=s.match(/Q(\d)[\/\s\-]?(\d{4})/i))return new Date(+m[2],(+m[1]-1)*3,1);
  if(m=s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/))return new Date(+m[3],+m[2]-1,+m[1]);
  if(m=s.match(/(\d{4})-(\d{2})-(\d{2})/))return new Date(+m[1],+m[2]-1,+m[3]);
  m=s.match(/\d{4}/);return m?new Date(+m[0],0,1):new Date('invalid');
}
function cleanName(s){return s.replace(/^(sum|avg|count|min|max|attr|median)\s*\(/i,'').replace(/\)$/,'').trim();}
function getParam(params,name){
  for(var i=0;i<params.length;i++)
    if(params[i].name.toLowerCase()===name.toLowerCase())
      return String(params[i].currentValue.value||params[i].currentValue.formattedValue||'').trim();
  return '';
}
// BUG 3 FIX: unified date normalizer → always outputs DD.MM.YYYY (dots) regardless of input format
// Handles: YYYY-MM-DD (from params), DD/MM/YYYY (Tableau locale), D.M.YYYY, already DD.MM.YYYY
function normDate(s){
  var t,x=String(s||'').trim();
  if((t=x.match(/^(\d{4})-(\d{2})-(\d{2})$/)))return t[3]+'.'+t[2]+'.'+t[1];
  if((t=x.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})$/)))
    return (t[1].length<2?'0':'')+t[1]+'.'+(t[2].length<2?'0':'')+t[2]+'.'+t[3];
  return x; // quarter / year / month labels — return as-is
}
function sortPts(g){return Object.values(g).filter(function(p){return !isNaN(p.d)&&p.d.getFullYear()>1990;}).sort(function(a,b){return a.d-b.d;});}
function mkTip(cb){return {backgroundColor:'#fff',borderColor:'#e5e7eb',borderWidth:1,titleColor:'#374151',bodyColor:'#111',padding:12,boxPadding:5,callbacks:cb};}

async function load(){
  G('period-cmp-row').style.display='none';
  try{
    var params=await ws.getParametersAsync();
    var frame=getParam(params,'frame');
    var dt=await ws.getSummaryDataAsync({ignoreSelection:true});
    var cols=dt.columns,rows=dt.data;

    var di=cols.findIndex(function(c){return c.fieldName.toLowerCase()==='truncated';});
    if(di<0)di=cols.findIndex(function(c){return c.dataType.toLowerCase().includes('date');});
    var rangeColIdx=cols.findIndex(function(c){return c.fieldName.toLowerCase()==='range';});

    var mi=-1,maxVal=-Infinity;
    cols.forEach(function(c,i){
      if(i===rangeColIdx||c.dataType.toLowerCase().includes('date'))return;
      if(!['float','int','real','integer','number'].some(function(t){return c.dataType.toLowerCase().includes(t);}))return;
      var colMax=0;
      rows.forEach(function(r){colMax=Math.max(colMax,Math.abs(parseFloat(r[i].value)||0));});
      if(colMax>maxVal){maxVal=colMax;mi=i;}
    });
    if(di<0||mi<0)return;

    var measureName=cleanName(cols[mi].fieldName);
    var L=applyLang(measureName);
    var pts,prv,last,lastPrv,curLabel,prevLabel;

    if(frame==='range'&&rangeColIdx>=0){
      var g1={},g2={};
      rows.forEach(function(r){
        var rv=String(r[rangeColIdx].value!=null?r[rangeColIdx].value:r[rangeColIdx].formattedValue||'');
        var key=r[di].formattedValue,d=parseDate(r[di].value,r[di].formattedValue),y=parseFloat(r[mi].value)||0;
        var g=rv==='1'?g1:rv==='2'?g2:null;
        if(g){if(!g[key])g[key]={x:key,y:0,d:d};g[key].y+=y;}
      });
      pts=sortPts(g1);var pts2=sortPts(g2);
      if(!pts.length)return;
      prv=pts.map(function(p,i){return pts2[i]||{x:null,y:null};});
      last=pts[pts.length-1];lastPrv=prv[prv.length-1];
      // BUG 3 FIX: normDate for range params (YYYY-MM-DD → DD.MM.YYYY with dots)
      curLabel=normDate(getParam(params,'from1'))+' - '+normDate(getParam(params,'to1'));
      prevLabel=normDate(getParam(params,'from2'))+' - '+normDate(getParam(params,'to2'));
      G('vs-label').textContent=isHebrew(measureName)?'השוואה:':'vs:';
      G('period-cmp-row').style.display='block';
    } else {
      var grouped={};
      rows.forEach(function(r){
        var key=r[di].formattedValue,d=parseDate(r[di].value,r[di].formattedValue),y=parseFloat(r[mi].value)||0;
        if(!grouped[key])grouped[key]={x:key,y:0,d:d};grouped[key].y+=y;
      });
      pts=Object.values(grouped).filter(function(p){return !isNaN(p.d)&&p.d.getFullYear()>1990&&p.y!==0;}).sort(function(a,b){return a.d-b.d;});
      if(!pts.length)return;
      prv=pts.map(function(p){
        var target=new Date(p.d);target.setFullYear(target.getFullYear()-1);
        var best=null,bestDiff=Infinity;
        pts.forEach(function(q){var diff=Math.abs(q.d-target);if(diff<bestDiff&&diff<20*864e5){bestDiff=diff;best=q;}});
        return best||{x:null,y:null};
      });
      last=pts[pts.length-1];lastPrv=prv[prv.length-1];
      // BUG 3 FIX: normDate on last year labels so DD/MM/YYYY → DD.MM.YYYY (consistent dots)
      curLabel=normDate(last.x);prevLabel=lastPrv?normDate(lastPrv.x||'N/A'):'N/A';
      G('vs-label').textContent=L.vs;G('period-cmp-row').style.display='block';
    }

    G('lbl').textContent=measureName;G('val').textContent=fmt(last.y);
    G('cur').textContent=curLabel;G('cur').className='date-val';
    G('prev').textContent=prevLabel;G('prev').className='date-val';

    var color='#6366f1';
    if(lastPrv&&lastPrv.y!=null&&lastPrv.y!==0){
      var diff=last.y-lastPrv.y,pct=Math.abs(diff/Math.abs(lastPrv.y)*100).toFixed(0),up=diff>0,neutral=Math.abs(diff)<0.0001;
      color=neutral?'#6366f1':up?'#16a34a':'#dc2626';
      G('chg').innerHTML='<span style="direction:ltr;unicode-bidi:embed">'+(neutral?'':up?'▲+':'▼-')+fmt(Math.abs(diff))+' ('+(neutral?'':up?'+':'-')+pct+'%)</span>';
      G('chg').className='chg '+(neutral?'':up?'up':'down');
    } else {G('chg').textContent='';}

    // Reuse chart if same type — instant in-place update, zero animation, no blank flash
    var needBubble=(pts.length===1);
    var tension=(frame==='range')?0:(pts.length<=4?0.1:0.4);
    var sameType=(ch&&ch.config&&((needBubble&&ch.config.type==='bubble')||(!needBubble&&ch.config.type==='line')));

    if(sameType){
      var ds=ch.data.datasets;
      if(needBubble){
        var bPrv=prv[0]&&prv[0].y!=null?prv[0].y:null;
        ds[0].data=[{x:0,y:pts[0].y,r:18}];ds[0].backgroundColor=hexToRgba(color,0.85);ds[0].borderColor=color;
        if(ds[1])ds[1].data=bPrv!=null?[{x:0,y:bPrv,r:14}]:[];
      } else {
        var cnv=G('ch'),hh=cnv.parentElement.offsetHeight||200,cx=cnv.getContext('2d');
        var g2=cx.createLinearGradient(0,0,0,hh);
        g2.addColorStop(0,hexToRgba(color,0.2));g2.addColorStop(1,hexToRgba(color,0));
        ch.data.labels=pts.map(function(p){return p.x;});
        ds[0].data=pts.map(function(p){return p.y;});ds[0].borderColor=color;ds[0].backgroundColor=g2;ds[0].tension=tension;
        ds[1].data=prv.map(function(p){return p.y;});ds[1].tension=tension;
      }
      ch.update('none');
    } else {
      if(ch){ch.destroy();ch=null;}
      var wrap=G('wrap');if(!wrap.querySelector('canvas')){wrap.innerHTML='<canvas id="ch"></canvas>';}
      var canvas=G('ch'),h=canvas.parentElement.offsetHeight||200;
      var ctx=canvas.getContext('2d'),grad=ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0,hexToRgba(color,0.2));grad.addColorStop(1,hexToRgba(color,0));
      if(needBubble){
        var bPrv2=prv[0]&&prv[0].y!=null?prv[0].y:null;
        ch=new Chart(canvas,{type:'bubble',data:{datasets:[
          {label:L.lineCur,data:[{x:0,y:pts[0].y,r:18}],backgroundColor:hexToRgba(color,0.85),borderColor:color,borderWidth:2},
          bPrv2!=null?{label:L.linePrv,data:[{x:0,y:bPrv2,r:14}],backgroundColor:'rgba(156,163,175,0.5)',borderColor:'rgba(156,163,175,0.8)',borderWidth:1.5}:{data:[]}
        ]},options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},tooltip:mkTip({label:function(c){return ' '+c.dataset.label+': '+fmt(c.raw.y);}})},
          scales:{x:{display:false},y:{display:false}},animation:{duration:0}}});
      } else {
        ch=new Chart(canvas,{type:'line',data:{
          labels:pts.map(function(p){return p.x;}),
          datasets:[
            {label:L.lineCur,data:pts.map(function(p){return p.y;}),borderColor:color,borderWidth:2,backgroundColor:grad,fill:true,tension:tension,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:color,pointHoverBorderColor:'#fff',pointHoverBorderWidth:2},
            {label:L.linePrv,data:prv.map(function(p){return p.y;}),borderColor:'rgba(156,163,175,.6)',borderWidth:1.5,borderDash:[4,3],fill:false,tension:tension,pointRadius:0,pointHoverRadius:4}
          ]
        },options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
          plugins:{legend:{display:false},tooltip:mkTip({label:function(c){return c.raw==null?null:' '+c.dataset.label+': '+fmt(c.raw);}})},
          scales:{x:{display:false},y:{display:false}},animation:{duration:0}}});
      }
    }

    // Reveal once on first load — subsequent updates paint in-place, no hide/show
    if(firstLoad){G('app').style.opacity='1';firstLoad=false;}

  }catch(e){
    console.error('KPI v47 error:',e);
    G('val').textContent='Error';G('chg').textContent=e.message||'check console';G('chg').className='chg down';
    if(firstLoad){G('app').style.opacity='1';firstLoad=false;}
  }
  setFonts();
}

// Simple debounce — no sync needed because updates are instant (animation:0, in-place)
function debouncedLoad(){clearTimeout(timer);timer=setTimeout(load,150);}

async function init(){
  if(typeof tableau==='undefined'){setTimeout(init,50);return;}
  await tableau.extensions.initializeAsync();
  ws=tableau.extensions.worksheetContent.worksheet;
  setFonts();load();
  ws.addEventListener(tableau.TableauEventType.SummaryDataChanged,debouncedLoad);
  try{
    var params=await ws.getParametersAsync();
    params.forEach(function(p){p.addEventListener(tableau.TableauEventType.ParameterChanged,debouncedLoad);});
  }catch(e){console.warn('No param listener:',e);}
}
window.onload=init;
</script>
</body></html>
